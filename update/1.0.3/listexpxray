#!/bin/bash
COLOR1='\033[0;35m'
NC='\e[0m'

DB="/var/lib/minacantik/pemakaian.db"

# Execute the SQLite query and store the result in a variable
result=$(sqlite3 -separator "|" $DB "SELECT * FROM userexp;")

echo -e "$COLOR1â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
echo -e "$COLOR1â”‚${NC} ${COLBG1}            â€¢ LIST EXP USER XRAY â€¢             ${NC} $COLOR1â”‚$NC"
echo -e "$COLOR1â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
# Print the table headers
printf "%-10s %-10s %-20s\n" "username" "protocol" "exp" 

# Read the result line by line
while IFS= read -r line; do
    # Split the line into an array of fields
    IFS="|" read -ra row <<< "$line"
    # Print the table row
    # convert timestamp to date in ${row[3]}
    timestamp=${row[3]}
    # timestamp to date with hour and minute
    date=$(date -d @$timestamp +"%d-%m-%Y %H:%M")


    printf "%-10s %-10s %-20s\n" "${row[0]}" "${row[1]}" "$date" 
done <<< "$result"
echo -e "$COLOR1â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
echo -e "Pencet ctrl+c to exit"
read -p "restore(username): " restore
# cek apakah ada username yang diinput di database
cekuser=$(sqlite3 "$DB" "SELECT username FROM userexp WHERE username = '$restore';")
if [[ $cekuser == "" ]]; then
echo "username tidak ada"
exit 0
elif [[ $restore == "" ]]; then
echo "username tidak boleh kosong"
exit 0
fi
read -p "exp (hari): " masaaktif
read -p "limit ip: " ip
read -p "limit kuota: " bw
# bw is byte, convert to GB
bw=$(($bw*1024*1024*1024))


protocol=$(sqlite3 "$DB" "SELECT protocol FROM userexp WHERE username = '$restore';")
uuid=$(sqlite3 "$DB" "SELECT id FROM userexp WHERE username = '$restore';")
# exp=$(sqlite3 "$DB" "SELECT exp FROM userexp WHERE username = '$restore';")
timestamp=$(date +%s)
# Convert timestamp to a date, add 3 days, then convert back to a timestamp
exp=$(date -d "$(date -d "@$timestamp") + $masaaktif days" +%s)

if [ "$protocol" = "vmess" ]; then
sed -i '/#vmess$/a\### '"$restore -"'\
},{"id": "'""$uuid""'","alterId": '"0"',"email": "'""$restore""'"' /etc/xray/config.json

sed -i '/#vmessgrpc$/a\### '"$restore -"'\
},{"id": "'""$uuid""'","alterId": '"0"',"email": "'""$restore""'"' /etc/xray/config.json
QUERY="INSERT INTO user (username, protocol, id, exp, ip, bw) VALUES ('$restore', 'vmess', '$uuid', '$exp', '$ip', '$bw');"
sqlite3 $DB "$QUERY"
fi
if [ "$protocol" = "vless" ]; then
sed -i '/#vless$/a\#& '"$restore -"'\
},{"id": "'""$uuid""'","email": "'""$restore""'"' /etc/xray/config.json
sed -i '/#vlessgrpc$/a\#& '"$restore -"'\
},{"id": "'""$uuid""'","email": "'""$restore""'"' /etc/xray/config.json
QUERY="INSERT INTO user (username, protocol, id, exp, ip, bw) VALUES ('$restore', 'vless', '$uuid', '$exp', '$ip', '$bw');"
sqlite3 $DB "$QUERY"
fi
if [ "$protocol" = "trojan" ]; then
sed -i '/#trojanws$/a\#! '"$restore -"'\
},{"password": "'""$uuid""'","email": "'""$restore""'"' /etc/xray/config.json
sed -i '/#trojangrpc$/a\#! '"$restore -"'\
},{"password": "'""$uuid""'","email": "'""$restore""'"' /etc/xray/config.json
QUERY="INSERT INTO user (username, protocol, id, exp, ip, bw) VALUES ('$restore', 'trojan', '$uuid', '$exp', '$ip', '$bw');"
sqlite3 $DB "$QUERY"
fi

sqlite3 $DB "DELETE FROM userexp WHERE username = '$restore';"

service xray restart > /dev/null 2>&1


